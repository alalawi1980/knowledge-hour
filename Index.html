<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©</title>

  <!-- Bootstrap + Chart.js + SheetJS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4fafd;
      padding: 0;
      margin: 0;
    }
    #loginScreen {
      height: 100vh;
      background: #002147;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #mainContent {
      display: none;
      padding: 20px;
    }
    .form-control, .btn {
      border-radius: 8px;
    }
    .logo-header {
      background: #001c3d;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      border-bottom: 3px solid #00bcd4;
    }
    .logo-header img {
      height: 50px;
    }
    footer {
      text-align: center;
      color: #888;
      font-size: 0.9em;
      margin-top: 40px;
    }
  </style>
</head>
<body>

<!-- âœ… Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginScreen">
  <img src="logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ø¹Ø§Ù…Ø©" style="max-height: 100px;" class="mb-4" />
  <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <div class="form-group mt-3 w-25">
    <input type="text" id="username" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <input type="password" id="password" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button class="btn btn-light w-100" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- âœ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="mainContent">
  <div class="logo-header">
    <img src="logo.png" alt="Ø´Ø¹Ø§Ø±" />
    <div>
      ğŸ‘¤ <strong id="userDisplay">ICV</strong>
      <button onclick="logout()" class="btn btn-sm btn-danger ms-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  <div class="container mt-4">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#formTab">Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#dashboardTab">Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- âœ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø© -->
      <div class="tab-pane fade show active" id="formTab">
        <form id="dataForm" onsubmit="return false;">
          <div class="row g-3">
            <div class="col-md-6"><input class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©" id="eventName" required /></div>
            <div class="col-md-6"><input class="form-control" placeholder="Ù†ÙˆØ¹Ù‡Ø§" id="eventType" required /></div>
            <div class="col-md-6"><input class="form-control" placeholder="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ÙØ°Ø©" id="executingBody" /></div>
            <div class="col-md-6"><input class="form-control" placeholder="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©" id="targetBody" /></div>
            <div class="col-md-6"><input type="date" class="form-control" id="eventDate" /></div>
            <div class="col-md-6"><input class="form-control" placeholder="Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯" id="timeSlot" /></div>
            <div class="col-md-6"><input type="number" class="form-control" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±" id="attendance" /></div>
            <div class="col-md-6"><input class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" id="notes" /></div>
          </div>
          <button type="button" class="btn btn-success mt-4 px-4" id="submitBtn">â• Ø¥Ø¶Ø§ÙØ©</button>
        </form>

        <hr />
        <table class="table table-bordered table-hover mt-3" id="dataTable">
          <thead class="table-primary text-center">
            <tr>
              <th>Ù…</th><th>Ø§Ø³Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©</th><th>Ù†ÙˆØ¹Ù‡Ø§</th><th>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ÙØ°Ø©</th><th>Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="mt-4 text-center">
          <button class="btn btn-outline-primary me-2" onclick="exportToExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
          <button class="btn btn-outline-dark" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
      <!-- âœ… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ -->
      <div class="tab-pane fade" id="dashboardTab">
        <div class="row mt-4">
          <div class="col-md-6">
            <h5 class="text-center">ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</h5>
            <canvas id="chartType"></canvas>
          </div>
          <div class="col-md-6">
            <h5 class="text-center">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ ÙØ¹Ø§Ù„ÙŠØ©</h5>
            <canvas id="chartAttendance"></canvas>
          </div>
          <div class="col-md-12 mt-4">
            <h5 class="text-center">ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h5>
            <canvas id="chartTarget"></canvas>
          </div>
        </div>
      </div>
    </div>

    <footer>Â© Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙˆØ·Ù†ÙŠ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ù„ÙŠ @2025</footer>
  </div>
</div>
<script>
  const submitBtn = document.getElementById("submitBtn");
  const tableBody = document.querySelector("#dataTable tbody");
  let data = JSON.parse(localStorage.getItem("knowledgeData")) || [];
  let rowIndex = data.length ? Math.max(...data.map(d => d.id)) + 1 : 1;
  let editMode = false;
  let editId = null;

  function login() {
    const u = document.getElementById("username").value.trim();
    const p = document.getElementById("password").value.trim();
    if (u === "ICV" && p === "Oman@12345") {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      document.getElementById("userDisplay").textContent = u;
      renderTable();
      updateDashboard();
    } else {
      alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }
  }

  function logout() {
    location.reload();
  }

  submitBtn.addEventListener("click", function () {
    const entry = getFormData(editId);
    if (!entry) return;

    if (editMode) {
      data = data.map(d => d.id === editId ? entry : d);
      editMode = false;
      editId = null;
      submitBtn.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
      renderTable();
    } else {
      data.push(entry);
      appendRow(entry);
    }

    saveData();
    document.getElementById("dataForm").reset();
    updateDashboard();
  });

  function getFormData(editId = null) {
    const eventName = document.getElementById("eventName").value.trim();
    const eventType = document.getElementById("eventType").value.trim();
    const executingBody = document.getElementById("executingBody").value.trim();
    const targetBody = document.getElementById("targetBody").value.trim();
    const eventDate = document.getElementById("eventDate").value;
    const timeSlot = document.getElementById("timeSlot").value.trim();
    const attendance = document.getElementById("attendance").value;
    const notes = document.getElementById("notes").value.trim();

    if (!eventName || !eventType) {
      alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ© ÙˆÙ†ÙˆØ¹Ù‡Ø§");
      return null;
    }

    return {
      id: editId || rowIndex++,
      eventName,
      eventType,
      executingBody,
      targetBody,
      eventDate,
      timeSlot,
      attendance,
      notes
    };
  }

  function appendRow(entry) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${entry.id}</td><td>${entry.eventName}</td><td>${entry.eventType}</td>
      <td>${entry.executingBody}</td><td>${entry.targetBody}</td>
      <td>${entry.eventDate}</td><td>${entry.timeSlot}</td><td>${entry.attendance}</td>
      <td>${entry.notes}</td>
      <td>
        <button class="btn btn-warning btn-sm me-1" onclick="editRow(${entry.id})">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRow(${entry.id})">ğŸ—‘</button>
      </td>
    `;
    row.dataset.id = entry.id;
    tableBody.appendChild(row);
  }

  function renderTable() {
    tableBody.innerHTML = "";
    data.forEach(entry => appendRow(entry));
  }

  function deleteRow(id) {
    data = data.filter(d => d.id !== id);
    saveData();
    renderTable();
    updateDashboard();
  }

  function editRow(id) {
    const entry = data.find(d => d.id === id);
    if (!entry) return;

    document.getElementById("eventName").value = entry.eventName;
    document.getElementById("eventType").value = entry.eventType;
    document.getElementById("executingBody").value = entry.executingBody;
    document.getElementById("targetBody").value = entry.targetBody;
    document.getElementById("eventDate").value = entry.eventDate;
    document.getElementById("timeSlot").value = entry.timeSlot;
    document.getElementById("attendance").value = entry.attendance;
    document.getElementById("notes").value = entry.notes;

    editMode = true;
    editId = id;
    submitBtn.textContent = "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
  }

  function saveData() {
    localStorage.setItem("knowledgeData", JSON.stringify(data));
  }

  function updateDashboard() {
    const typeCounts = {}, attendanceCounts = {}, targetCounts = {};
    data.forEach(entry => {
      typeCounts[entry.eventType] = (typeCounts[entry.eventType] || 0) + 1;
      attendanceCounts[entry.eventName] = parseInt(entry.attendance) || 0;
      targetCounts[entry.targetBody] = (targetCounts[entry.targetBody] || 0) + 1;
    });
    drawChart("chartType", "pie", typeCounts, 'Ù†ÙˆØ¹ Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª');
    drawChart("chartAttendance", "bar", attendanceCounts, 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±');
    drawChart("chartTarget", "bar", targetCounts, 'Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©', true);
  }

  function drawChart(id, type, dataMap, label, horizontal = false) {
    const ctx = document.getElementById(id);
    if (ctx.chart) ctx.chart.destroy();
    ctx.chart = new Chart(ctx, {
      type: type,
      data: {
        labels: Object.keys(dataMap),
        datasets: [{
          label: label,
          data: Object.values(dataMap),
          backgroundColor: ["#4FC3F7", "#81C784", "#FFB74D", "#E57373"]
        }]
      },
      options: {
        indexAxis: horizontal ? 'y' : 'x',
        responsive: true,
        scales: type !== "pie" ? { y: { beginAtZero: true } } : {}
      }
    });
  }

  function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const ws_data = [["Ù…", "Ø§Ø³Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©", "Ù†ÙˆØ¹Ù‡Ø§", "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ù†ÙØ°Ø©", "Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©", "Ø§Ù„ØªØ§Ø±ÙŠØ®", "Ø§Ù„ÙˆÙ‚Øª", "Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±", "Ù…Ù„Ø§Ø­Ø¸Ø§Øª"]];
    data.forEach(entry => {
      ws_data.push([entry.id, entry.eventName, entry.eventType, entry.executingBody, entry.targetBody, entry.eventDate, entry.timeSlot, entry.attendance, entry.notes]);
    });
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ§Øª");
    XLSX.writeFile(wb, "Ø³Ø¬Ù„_Ø³Ø§Ø¹Ø©_Ø§Ù„Ù…Ø¹Ø±ÙØ©.xlsx");
  }

  function printReport() {
    const original = document.body.innerHTML;
    const report = document.querySelector(".tab-content").innerHTML;
    const style = `<style>body{direction:rtl;font-family:'Segoe UI'}table,th,td{border:1px solid #999;border-collapse:collapse;padding:6px;text-align:center}canvas{page-break-inside:avoid;margin-bottom:20px}</style>`;
    document.body.innerHTML = style + report;
    window.print();
    document.body.innerHTML = original;
    location.reload();
  }
</script>
</body>
</html>
